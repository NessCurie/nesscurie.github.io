<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Android Accessibility大致解析,通过adb运行纯java代码打开应用的辅助功能 | Möbius Strip World</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android Accessibility大致解析,通过adb运行纯java代码打开应用的辅助功能</h1><a id="logo" href="/.">Möbius Strip World</a><p class="description">What will your verse be ？</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android Accessibility大致解析,通过adb运行纯java代码打开应用的辅助功能</h1><div class="post-meta">Mar 7, 2017<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><a class="disqus-comment-count" href="/2017/03/07/Android%E8%BE%85%E5%8A%A9%E5%8A%9F%E8%83%BD%E5%A4%A7%E8%87%B4%E8%A7%A3%E6%9E%90,%E9%80%9A%E8%BF%87adb%E8%BF%90%E8%A1%8C%E7%BA%AFjava%E4%BB%A3%E7%A0%81%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8%E7%9A%84%E8%BE%85%E5%8A%A9%E5%8A%9F%E8%83%BD/#vcomment"><span class="valine-comment-count" data-xid="/2017/03/07/Android%E8%BE%85%E5%8A%A9%E5%8A%9F%E8%83%BD%E5%A4%A7%E8%87%B4%E8%A7%A3%E6%9E%90,%E9%80%9A%E8%BF%87adb%E8%BF%90%E8%A1%8C%E7%BA%AFjava%E4%BB%A3%E7%A0%81%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8%E7%9A%84%E8%BE%85%E5%8A%A9%E5%8A%9F%E8%83%BD/"></span><span> Comment</span></a><div class="post-content"><h3 id="Android的辅助功能accessibility的具体文档可以查看-google-accessibility说明文档"><a href="#Android的辅助功能accessibility的具体文档可以查看-google-accessibility说明文档" class="headerlink" title="Android的辅助功能accessibility的具体文档可以查看:google accessibility说明文档"></a>Android的辅助功能accessibility的具体文档可以查看:<a href="https://developer.android.com/guide/topics/ui/accessibility/index.html" target="_blank" rel="noopener">google accessibility说明文档</a></h3><p>accessibility是一个非常强大的功能,可以实现监听手机上的各种事件,比如窗口的变化,查找屏幕上当前显示的文字,以及模拟点击等功能,并且通过accessibility可以完成很多一般应用无法完成事件,比如发送物理或虚拟返回键的指令是通过如下代码实现的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Instrumentation inst = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">            inst.sendKeyDownUpSync(KeyEvent.KEYCODE_BACK);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure>

<p>该指令是需要在系统进程中运行的应用使用才会生效的命令,不过如果使用辅助功能就可以通过发送全局操作触发该操作.这样就可以完成在非root的手机上实现悬浮球的返回键的功能.</p>
<p>另外辅助功能还可以实现各种脚本和无root权限伪静默安装.绿色守护的非root模式和uc的静默安装还有那些抢红包的应用都是用该方式实现的,不过如果一些恶意应用拿到了辅助功能的权限是灾难性的.</p>
<p>辅助功能的开启关闭是在Android的系统设置中的辅助功能或者叫无障碍选项中.</p>
<hr>
<h2 id="如何编写一个辅助功能服务"><a href="#如何编写一个辅助功能服务" class="headerlink" title="如何编写一个辅助功能服务"></a>如何编写一个辅助功能服务</h2><h3 id="1-创建一个class继承于AccessibilityService-会强制重写2个方法"><a href="#1-创建一个class继承于AccessibilityService-会强制重写2个方法" class="headerlink" title="1.创建一个class继承于AccessibilityService,会强制重写2个方法"></a>1.创建一个class继承于AccessibilityService,会强制重写2个方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当系统检测到一个匹配你辅助服务过滤器中设置参数的AccessibilityEvent时，调用该方法，运行时多次调用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event 在用户交互使用时系统返回的event事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * 当你的服务对系统事件的反馈被中断时，调用该方法。该方法同上面方法一样，也是被多次调用的</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-接下来有2种选择"><a href="#2-接下来有2种选择" class="headerlink" title="2.接下来有2种选择"></a>2.接下来有2种选择</h3><ol>
<li><p>可以在res中创建xml文件夹,创建一个xml文件,文件名随意,在xml文件中对辅助服务进行配置,格式大致如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">accessibility-service</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:accessibilityEventTypes</span>=<span class="string">"typeNotificationStateChanged"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:accessibilityFeedbackType</span>=<span class="string">"feedbackGeneric"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:accessibilityFlags</span>=<span class="string">"flagReportViewIds"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:notificationTimeout</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:canRetrieveWindowContent</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:packageNames</span>=<span class="string">"com.nesscurie.accessibility"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重写onServiceConnected() (当应用成功连接到你的辅助性服务时，系统调用该方法)在该方法中进行配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AccessibilityServiceInfo serviceInfo = <span class="keyword">new</span> AccessibilityServiceInfo();</span><br><span class="line">serviceInfo.eventTypes = ...;</span><br><span class="line">serviceInfo.feedbackType = ...;</span><br><span class="line">serviceInfo.notificationTimeout = ...;</span><br><span class="line">serviceInfo.packageNames = <span class="keyword">new</span> String[]&#123;...&#125;;  </span><br><span class="line">serviceInfo.flags =  ...;</span><br><span class="line">setServiceInfo(serviceInfo);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="各属性解释"><a href="#各属性解释" class="headerlink" title="各属性解释:"></a>各属性解释:</h5><ol>
<li><p><code>accessibilityEventTypes / eventTypes</code> 事件类型</p>
<p> <code>typeAllMask / AccessibilityEvent.TYPES_ALL_MASK</code> 全局事件响应<br> <code>typeViewClicked / AccessibilityEvent.TYPE_VIEW_CLICKED</code> 点击事件</p>
</li>
<li><p><code>accessibilityFeedbackType / feedbackType</code> 反馈方式</p>
<p> <code>feedbackGeneric / AccessibilityServiceInfo.FEEDBACK_GENERIC</code>  通用的反馈<br> <code>feedbackAudible  / AccessibilityServiceInfo.FEEDBACK_AUDIBLE</code>  声音反馈<br> <code>feedbackSpoken  / AccessibilityServiceInfo.FEEDBACK_SPOKEN</code>    语音反馈</p>
</li>
<li><p><code>notificationTimeout / notificationTimeout</code> 响应毫秒值</p>
</li>
<li><p><code>packageNames</code> 监听的应用的包名,可指定多个包名,xml文件中使用,隔开</p>
</li>
<li><p><code>accessibilityFlags / flags</code> 用于之后<code>node.getViewIdResourceName()</code>的权限</p>
</li>
<li><p><code>description</code> 辅助功能的描述</p>
</li>
<li><p><code>canRetrieveWindowContent</code> 从一个AccessibilityEvent中调查完全视图层级的能力隐式地暴露私有用户信息给你的辅助服务,必须通过配置XML文件请求这个级别的访问权,不在你的服务配置xml文件中包含这个设置，那么对<code>getSource()</code>的调用会失败。</p>
</li>
</ol>
<h3 id="3-在manifest中注册辅助功能的服务"><a href="#3-在manifest中注册辅助功能的服务" class="headerlink" title="3.在manifest中注册辅助功能的服务"></a>3.在manifest中注册辅助功能的服务</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".MyAccessibilityService"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"我的辅助功能"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:permission</span>=<span class="string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice.AccessibilityService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>name：对应的是自定义service的包名</p>
<p>label：对应了在系统辅助功能开关界面中，你的service的名字</p>
<p>description：则是点击对应的服务进入开关界面后，该服务的简介</p>
<p>permission：对应的权限（亦可在service中单独写出来)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>intent-filter：指定了执行的组件为辅助功能类</p>
<h5 id="如果是使用xml文件配置的辅助服务-还需要在service节点下添加meta-data节点-在resource指定自己编写的xml文件"><a href="#如果是使用xml文件配置的辅助服务-还需要在service节点下添加meta-data节点-在resource指定自己编写的xml文件" class="headerlink" title="如果是使用xml文件配置的辅助服务,还需要在service节点下添加meta-data节点,在resource指定自己编写的xml文件"></a>如果是使用xml文件配置的辅助服务,还需要在service节点下添加meta-data节点,在resource指定自己编写的xml文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:resource</span>=<span class="string">"@xml/accessibility_config"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-接下来就可以在onAccessibilityEvent-AccessibilityEvent-event-处理各种事件"><a href="#4-接下来就可以在onAccessibilityEvent-AccessibilityEvent-event-处理各种事件" class="headerlink" title="4.接下来就可以在onAccessibilityEvent(AccessibilityEvent event)处理各种事件:"></a>4.接下来就可以在onAccessibilityEvent(AccessibilityEvent event)处理各种事件:</h3><h4 id="可以使用-event-getEventType-来获取各种事件消息"><a href="#可以使用-event-getEventType-来获取各种事件消息" class="headerlink" title="可以使用 event.getEventType()来获取各种事件消息:"></a>可以使用 <em>event.getEventType()</em>来获取各种事件消息:</h4><ol>
<li><p>基本窗口view的变化都可以使用这个type来监听:<br><code>AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED</code></p>
</li>
<li><p>打开popupwindow,菜单，对话框时候会触发:<br><code>AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED</code></p>
</li>
<li><p>更加精确的代表了基于当前event.source中的子view的内容变化:<br><code>AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED</code></p>
</li>
<li><p>窗口的变化:<br><code>AccessibilityEvent.TYPE_WINDOWS_CHANGED</code></p>
</li>
</ol>
<h4 id="当前event的节点信息-有两种方式获取"><a href="#当前event的节点信息-有两种方式获取" class="headerlink" title="当前event的节点信息.有两种方式获取:"></a>当前event的节点信息.有两种方式获取:</h4><ol>
<li><p>使用event获取:<br><code>AccessibilityNodeInfo nodeInfo = event.getSource();</code></p>
</li>
<li><p>在accessibility中直接获取:<br><code>AccessibilityNodeInfo nodeInfo = getRootInActiveWindow();</code></p>
</li>
</ol>
<h4 id="使用完要记得调用recycle-进行释放以免内存泄漏"><a href="#使用完要记得调用recycle-进行释放以免内存泄漏" class="headerlink" title="使用完要记得调用recycle();进行释放以免内存泄漏"></a>使用完要记得调用recycle();进行释放以免内存泄漏</h4><p><code>nodeInfo.recycle();</code></p>
<h4 id="接下来就可以使用下面的方法来获取对应的所有节点的集合"><a href="#接下来就可以使用下面的方法来获取对应的所有节点的集合" class="headerlink" title="接下来就可以使用下面的方法来获取对应的所有节点的集合"></a>接下来就可以使用下面的方法来获取对应的所有节点的集合</h4><p><code>findAccessibilityNodeInfosByViewId(String str)</code><br><code>findAccessibilityNodeInfosByText(String str)</code></p>
<h4 id="获取id的方法"><a href="#获取id的方法" class="headerlink" title="获取id的方法:"></a>获取id的方法:</h4><ol>
<li><p>使用DDMS的hierarchy View来查找对应的viewId,但是有很多手机是没有办法获取,只会提示:Unable to get view server version from device XXXXX</p>
</li>
<li><p>在这个时候，在AccessibiltiyService的配置中添加的flag。flagReportViewIds就可以派上用场了</p>
<p> 在窗口改变时,获取并遍历所有的node，即打印出node对应的文字和id</p>
<p> 传入方法id的格式为: 应用的包名 + “:id/“ + 获取到的id</p>
</li>
</ol>
<h5 id="获取到节点之后即可使用节点进行点击等各种事件"><a href="#获取到节点之后即可使用节点进行点击等各种事件" class="headerlink" title="获取到节点之后即可使用节点进行点击等各种事件:"></a>获取到节点之后即可使用节点进行点击等各种事件:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">performAction(AccessibilityNodeInfo.ACTION_CLICK) </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;AccessibilityNodeInfo中有各种各样的事件以常量的形势声明.</span><br></pre></td></tr></table></figure>

<h4 id="除了使用节点进行调用还可以调用全局事件"><a href="#除了使用节点进行调用还可以调用全局事件" class="headerlink" title="除了使用节点进行调用还可以调用全局事件:"></a>除了使用节点进行调用还可以调用全局事件:</h4><p>返回键<br><code>performGlobalAction(AccessibilityService.GLOBAL_ACTION_BACK);</code><br>HOME键<br><code>performGlobalAction(AccessibilityService.GLOBAL_ACTION_HOME);</code><br>最近打开应用列表<br><code>performGlobalAction(AccessibilityService.GLOBAL_ACTION_RECENTS);</code><br>打开通知栏<br><code>performGlobalAction(AccessibilityService.GLOBAL_ACTION_NOTIFICATIONS);</code><br>锁屏<br><code>performGlobalAction(AccessibilityService.GLOBAL_ACTION_POWER_DIALOG);</code><br>设置<br><code>performGlobalAction(AccessibilityService.GLOBAL_ACTION_QUICK_SETTINGS);</code>  </p>
<h4 id="判断对应的辅助功能有没有打开的方法"><a href="#判断对应的辅助功能有没有打开的方法" class="headerlink" title="判断对应的辅助功能有没有打开的方法:"></a>判断对应的辅助功能有没有打开的方法:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccessibilitySettingsOn</span><span class="params">(Context mContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> accessibilityEnabled = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> String service = getPackageName() + <span class="string">"/"</span> + MyAccessibilityService<span class="class">.<span class="keyword">class</span>.<span class="title">getCanonicalName</span>()</span>;  <span class="comment">//这里改成自己的class</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        accessibilityEnabled = Settings.Secure.getInt(mContext.getApplicationContext().getContentResolver(),</span><br><span class="line">                Settings.Secure.ACCESSIBILITY_ENABLED);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Settings.SettingNotFoundException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    TextUtils.SimpleStringSplitter mStringColonSplitter = <span class="keyword">new</span> TextUtils.SimpleStringSplitter(<span class="string">':'</span>);</span><br><span class="line">    <span class="keyword">if</span> (accessibilityEnabled == <span class="number">1</span>) &#123;</span><br><span class="line">        String settingValue = Settings.Secure.getString(mContext.getApplicationContext().getContentResolver(),</span><br><span class="line">                Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES);</span><br><span class="line">        <span class="keyword">if</span> (settingValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mStringColonSplitter.setString(settingValue);</span><br><span class="line">            <span class="keyword">while</span> (mStringColonSplitter.hasNext()) &#123;</span><br><span class="line">                String accessibilityService = mStringColonSplitter.next();</span><br><span class="line">                <span class="keyword">if</span> (accessibilityService.equalsIgnoreCase(service)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法就是通过获取系统设置的存储辅助功能的数据库的内容提供者,然后查看已开的辅助功能的包名+类名<br>是否有自己,有就表示开了.(后面的用java程序悄悄打开对应的辅助功能其实就是去修改这个值)</p>
<h5 id="打开系统设置辅助功能的界面"><a href="#打开系统设置辅助功能的界面" class="headerlink" title="打开系统设置辅助功能的界面:"></a>打开系统设置辅助功能的界面:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="辅助功能的介绍就是这些-下面开始使用adb运行java程序悄悄打开辅助功能-系统设置的各个选项通过数据库形式进行保存-通过user为shell的高权限将系统设置存储的配置进行修改"><a href="#辅助功能的介绍就是这些-下面开始使用adb运行java程序悄悄打开辅助功能-系统设置的各个选项通过数据库形式进行保存-通过user为shell的高权限将系统设置存储的配置进行修改" class="headerlink" title="辅助功能的介绍就是这些,下面开始使用adb运行java程序悄悄打开辅助功能:系统设置的各个选项通过数据库形式进行保存,通过user为shell的高权限将系统设置存储的配置进行修改."></a>辅助功能的介绍就是这些,下面开始使用adb运行java程序悄悄打开辅助功能:系统设置的各个选项通过数据库形式进行保存,通过user为shell的高权限将系统设置存储的配置进行修改.</h3><h4 id="在此之前先写一个简单的辅助功能应用"><a href="#在此之前先写一个简单的辅助功能应用" class="headerlink" title="在此之前先写一个简单的辅助功能应用:"></a>在此之前先写一个简单的辅助功能应用:</h4><ol>
<li><p>编写一个类继承AccessibilityService,只在onStartCommand做一个返回键的全局操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAccessibilityService</span> <span class="keyword">extends</span> <span class="title">AccessibilityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        performGlobalAction(AccessibilityService.GLOBAL_ACTION_BACK);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>xml配置最普通的内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">accessibility-service</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:accessibilityEventTypes</span>=<span class="string">"typeNotificationStateChanged"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:accessibilityFeedbackType</span>=<span class="string">"feedbackGeneric"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:accessibilityFlags</span>=<span class="string">"flagDefault"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:notificationTimeout</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:canRetrieveWindowContent</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:packageNames</span>=<span class="string">"com.nesscurie.accessibility"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在清单文件进行注册</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".MyAccessibilityService"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"我的辅助功能"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:permission</span>=<span class="string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice.AccessibilityService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:resource</span>=<span class="string">"@xml/accessibility_config"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在Activity的xml文件中设置一个button,为了方便,声明onClick属性为onClick,在activity中编写onClick方法为如下内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isAccessibilitySettingsOn(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    startService(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyAccessibilityService<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>部署到设备上,打开应用点击按钮可以发现打开了系统设置的辅助功能的界面,开启对应的辅助功能,回到app,可以发现点击按钮后触发了返回键的功能.</p>
<hr>
<h3 id="关闭该应用辅助功能-接下来就是编写能修改系统设置的纯java代码-使用adb的settings命令将设置的数据库中对应字段改变"><a href="#关闭该应用辅助功能-接下来就是编写能修改系统设置的纯java代码-使用adb的settings命令将设置的数据库中对应字段改变" class="headerlink" title="关闭该应用辅助功能,接下来就是编写能修改系统设置的纯java代码:使用adb的settings命令将设置的数据库中对应字段改变"></a>关闭该应用辅助功能,接下来就是编写能修改系统设置的纯java代码:使用adb的settings命令将设置的数据库中对应字段改变</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Temp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"running"</span>);</span><br><span class="line">        <span class="comment">//这里是包名+辅助功能类名</span></span><br><span class="line">        String cmd1 = <span class="string">"settings put secure enabled_accessibility_services com.nesscurie.accessibility/com.nesscurie.accessibility.MyAccessibilityService"</span>;</span><br><span class="line">        </span><br><span class="line">        String cmd2 = <span class="string">"settings put secure accessibility_enabled 1"</span>;</span><br><span class="line">        execShell(cmd1);</span><br><span class="line">        execShell(cmd2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//运行命令行的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execShell</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process p = Runtime.getRuntime().exec(cmd);</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(</span><br><span class="line">                    p.getInputStream()));</span><br><span class="line">            String readLine = br.readLine();</span><br><span class="line">            <span class="keyword">while</span> (readLine != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(readLine);</span><br><span class="line">                readLine = br.readLine();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                br.close();</span><br><span class="line">            &#125;</span><br><span class="line">            p.destroy();</span><br><span class="line">            p = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用上一篇中的方法,将代码编译为.class后转为.dex,push到手机中,比如data/local/tmp目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">cd data&#x2F;local&#x2F;tmp</span><br><span class="line">app_process -Djava.class.path&#x3D;Temp.dex data&#x2F;local&#x2F;tmp Temp</span><br></pre></td></tr></table></figure>

<p>可以看到打印出runnig后,系统设置的该应用的辅助功能界面刷新为开,本来是需要系统权限(设置运行在系统进程中,具有系统权限)才能进行修改的选项,就这么悄悄的打开了.</p>
<hr>
<p>辅助功能是一个非常强大的功能,不仅能为不少不方便的人群提供使用手机的方式,还可以带来不少特殊的体验,不过国内大部分app都没有针对少数不方便的人群进行辅助功能的开发,并且很多时候辅助功能被用在了不正确的途径,不禁是一件令人深思的事情.</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2017/03/10/Markdown%E7%9A%84%E4%B8%80%E4%BA%9B%E8%AF%B4%E6%98%8E%E5%92%8C%E5%B8%B8%E7%94%A8%E8%AF%AD%E6%B3%95/">Markdown的一些说明和常用语法</a><a class="next" href="/2017/03/02/%E5%9C%A8Android%E8%AE%BE%E5%A4%87%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%BA%AFjava%E4%BB%A3%E7%A0%81/">在Android设备上运行纯java代码</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'R2dcvRpPE66R69btJSJPByee-gzGzoHsz',
  appKey:'E9T5cJlOJ4pSgbFq1UcaPJ5y',
  placeholder:'Why so serious?',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/EditText/" style="font-size: 15px;">EditText</a> <a href="/tags/RecyclerView/" style="font-size: 15px;">RecyclerView</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/02/10/AboutMeInTheseFourYears/">新旅途之前的记录与总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/11/git/SVN%E8%BF%81%E7%A7%BB%E5%88%B0Git%E4%BF%9D%E7%95%99%E5%AE%8C%E6%95%B4%E7%9A%84log/">SVN迁移到Git保留完整的log</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/EditText%E8%BD%BB%E6%9D%BE%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BD%AF%E9%94%AE%E7%9B%98%E8%BE%93%E5%85%A5/">EditText 不使用系统键盘实现自定义键盘输入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/07/byte%E6%95%B0%E7%BB%84%E5%BC%8F%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/%E4%BD%BF%E7%94%A8%E6%A0%91%E7%BB%93%E6%9E%84%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AF%B9Java%E7%9A%84byte%E6%95%B0%E7%BB%84%E8%BF%9B%E8%A1%8C%E5%BF%AB%E9%80%9F%E8%A7%A3%E6%9E%90%E5%92%8C%E6%9E%84%E5%BB%BA/">使用树结构的方式对Java的byte数组进行快速解析和构建</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/28/byte%E6%95%B0%E7%BB%84%E5%BC%8F%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/%E5%B0%86Java%E7%9A%84byte%E6%95%B0%E7%BB%84%E5%88%86%E6%AE%B5%E8%A7%A3%E6%9E%90%E4%B8%BA%E6%89%80%E9%9C%80%E6%95%B0%E6%8D%AE%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BBBytesReader/">将Java的byte数组分段解析为所需数据的工具类BytesReader</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/byte%E6%95%B0%E7%BB%84%E5%BC%8F%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/%E5%8F%82%E7%85%A7ArrayList%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%83%BD%E6%B7%BB%E5%8A%A0%E4%BB%BB%E6%84%8F%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84ByteArrayList/">参照ArrayList实现一个能添加任意数据类型的ByteArrayList</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/21/byte%E6%95%B0%E7%BB%84%E5%BC%8F%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/%E5%A4%A7%E5%B0%8F%E7%AB%AFbyte%E6%95%B0%E7%BB%84%E5%92%8C%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%BA%92%E8%BD%AC/">大小端byte数组和各种数据类型的互转</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/12/%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83Android.mk%E7%BC%96%E8%AF%91APK/">源码环境Android.mk编译APK</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/07/Kotlin%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Kotlin基础语法笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/20/Python%E7%9A%84%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/">Python的文件操作和数据库操作</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://gallonyin.github.io/" title="GallonYin" target="_blank">GallonYin</a><ul></ul><a href="http://zphuanlove.github.io/" title="zhongpeihuan" target="_blank">zhongpeihuan</a><ul></ul><a href="https://blog.csdn.net/qq_33487044" title="雪松研究所" target="_blank">雪松研究所</a><ul></ul><a href="https://wkingdom.github.io/" title="WZKingdom" target="_blank">WZKingdom</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Möbius Strip World.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>